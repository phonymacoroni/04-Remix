<html>
  <body>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- <script src="https://d3js.org/d3-time.v2.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v3.min.js"></script> -->

    <div id="viz"></div>

    <script>
      console.log({ d3 });

      var margin = { top: 10, right: 30, bottom: 40, left: 50 },
        margin2 = { top: 430, right: 10, bottom: 20, left: 40 },
        width = 820 - margin.left - margin.right,
        height = 520 - margin.top - margin.bottom,
        height2 = 500 - margin2.top - margin2.bottom;

      // append the svg object to the body of the page
      var svg = d3
        .select("#viz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      d3.csv("/a4-softeng.csv").then(function (data) {
        console.log({ data });
        // console.log(JSON.parse(data))

        // Time formatting
        var parseDuration = d3.timeParse("%-H:%M:%S");
        var formatDuration = d3.timeFormat("%-H:%M:%S");
        console.log(formatDuration(parseDuration("14:18:21")));

        // var parseDateTime = d3.timeParse("%Y-%m-%d %I:%M:%S %p")
        var parseDateTime = d3.timeParse("%Y-%m-%d %X");

        // X axis
        var xBand = d3
          .scaleBand()
          .range([0, width])
          .domain(
            data.map(function (d) {
              //   console.log(parseDateTime(d.startDate + " " + d.startTime));
              return parseDateTime(d.startDate + " " + d.startTime);
            })
          )
          .padding(0.2);

        var barWidth = 20;
        barWidth = xBand.bandwidth();

        var x = d3
          .scaleTime()
          .domain(
            d3.extent(data, function (d) {
              return parseDateTime(d.startDate + " " + d.startTime);
            })
          )
          // .nice(d3.time.day, 1)
          .rangeRound([0, width - margin.left - margin.right]);

        var x2 = d3
          .scaleTime()
          .domain(
            d3.extent(data, function (d) {
              return parseDateTime(d.startDate + " " + d.startTime);
            })
          )
          // .nice(d3.time.day, 1)
          .rangeRound([0, width - margin.left - margin.right]);

        var brush = d3.svg.brush().x(x2).on("brush", brushed);

        svg
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "translate(-10,0)rotate(-45)")
          .style("text-anchor", "end");

        // Add Y axis
        // var y = d3
        //   .scaleTime()
        //   .domain(
        //     d3.extent(data, function (d) {
        //       return parseDuration(d.duration);
        //     })
        //   )
        //   .range([height, 0]);
        // svg.append("g").call(d3.axisLeft(y));

        var y = d3.scaleLinear().domain([0, 1000]).range([height, 0]);
        var y2 = d3.scaleLinear().domain([0, 1000]).range([height2, 0]);
        // var xAxis = d3.svg.axis().scale(x).orient("bottom");
        // var xAxis2 = d3.svg.axis().scale(x2).orient("bottom").tickValues([]);
        svg.append("g").call(d3.axisLeft(y));

        // Add X axis label
        svg
          .append("text")
          .attr("y", height + margin.bottom / 1.2)
          .attr("x", width / 2)
          .style("text-anchor", "middle")
          .text("Date");

        // Add Y axis label
        svg
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", -10 - margin.left / 2)
          .attr("x", 0 - height / 2)
          .style("text-anchor", "middle")
          .text("Minutes");

        var tooltip = d3
          .select("#viz")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "1px")
          .style("border-radius", "5px")
          .style("padding", "10px");

        var mouseOn = function (d) {
          tooltip.style("opacity", "1");
        };

        var mouseOff = function (d) {
          tooltip.style("opacity", "0");
        };

        var mouseOver = function (d) {
          //   console.log(d.toElement.__data__);
          tooltip.html(
            "Start Time: " +
              d.toElement.__data__.startTime +
              "<br>" +
              "Duration: " +
              formatDuration(parseDuration(d.toElement.__data__.duration))
          );
        };

        var focus = svg
          .append("g")
          .attr("class", "focus")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );
        var context = svg
          .append("g")
          .attr("class", "context")
          .attr(
            "transform",
            "translate(" + margin2.left + "," + margin2.top + ")"
          );

        focus
          .append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x2));

        focus.append("g").attr("class", "y axis").call(d3.axisLeft(y));

        console.log(x(data[0].date));
        enter(data);
        updateScale(data);

        var subBars = context.selectAll(".subBar").data(data);

        subBars
          .enter()
          .append("rect")
          .classed("subBar", true)
          .attr({
            height: function (d) {
              return height2 - y2(getDuration(parseDuration(d.duration)));
            },
            width: function (d) {
              return x.rangeBand();
            },
            x: function (d) {
              return x2(d.date);
            },
            y: function (d) {
              return y2(getDuration(parseDuration(d.duration)));
            },
          });

        // Bars
        svg
          .selectAll("mybar")
          .data(data)
          .enter()
          .append("rect")
          .attr("x", function (d) {
            return x(parseDateTime(d.startDate + " " + d.startTime));
          })
          .attr("y", function (d) {
            // return y(parseDuration(d.duration));
            return y(getDuration(parseDuration(d.duration)));
          })
          .attr("width", barWidth)
          .attr("height", function (d) {
            //   console.log(d.duration)
            //   console.log(parseDuration(d.duration))
            return height - y(getDuration(parseDuration(d.duration)));
            // console.log(d)
            // return 100;
          })
          .attr("fill", "#69b3a2")
          .on("mousemove", mouseOver)
          //   .on("mousemove", function (d){
          //       console.log(d)
          //   })
          .on("mouseover", mouseOn)
          .on("mouseleave", mouseOff);
      });

      // Get Duration in minutes
      function getDuration(dur) {
        // console.log(dur);
        // console.log(dur.getHours() * 60 + dur.getMinutes());
        return dur.getHours() * 60 + dur.getMinutes();
      }

      function brushed() {
        var selected = null;
        selected = x2.domain().filter(function (d) {
          return brush.extent()[0] <= x2(d) && x2(d) <= brush.extent()[1];
        });

        var start;
        var end;

        if (brush.extent()[0] != brush.extent()[1]) {
          start = selected[0];
          end = selected[selected.length - 1] + 1;
        } else {
          start = 0;
          end = data.length;
        }

        var updatedData = data.slice(start, end);

        update(updatedData);
        enter(updatedData);
        exit(updatedData);
        updateScale(updatedData);
      }

      function updateScale(data) {
        var tickScale = d3.scale
          .pow()
          .range([data.length / 10, 0])
          .domain([data.length, 0])
          .exponent(0.5);

        var brushValue = brush.extent()[1] - brush.extent()[0];
        if (brushValue === 0) {
          brushValue = width;
        }

        var tickValueMultiplier = Math.ceil(Math.abs(tickScale(brushValue)));
        var filteredTickValues = data
          .filter(function (d, i) {
            return i % tickValueMultiplier === 0;
          })
          .map(function (d) {
            return d.date;
          });

        focus.select(".x.axis").call(xAxis.tickValues(filteredTickValues));
        focus.select(".y.axis").call(d3.axisLeft(y));
      }

      function update(data) {
        x.domain(
          data.map(function (d) {
            return d.date;
          })
        );
        y.domain([
          0,
          d3.max(data, function (d) {
            return getDuration(parseDuration(d.duration));
          }),
        ]);

        var bars = focus.selectAll(".bar").data(data);
        bars.attr({
          height: function (d, i) {
            return height - y(getDuration(parseDuration(d.duration)));
          },
          width: function (d) {
            return x.rangeBand();
          },
          x: function (d) {
            return x(d.date);
          },
          y: function (d) {
            return y(getDuration(parseDuration(d.duration)));
          },
        });
      }

      function exit(data) {
        var bars = focus.selectAll(".bar").data(data);
        bars.exit().remove();
      }

      function enter(data) {
        x.domain(
          data.map(function (d) {
            return d.date;
          })
        );
        y.domain([
          0,
          d3.max(data, function (d) {
            return getDuration(parseDuration(d.duration));
          }),
        ]);

        var bars = focus.selectAll(".bar").data(data);
        bars
          .enter()
          .append("rect")
          .classed("bar", true)
          .attr({
            height: function (d, i) {
              return height - y(getDuration(parseDuration(d.duration)));
            },
            width: function (d) {
              return x.rangeBand();
            },
            x: function (d) {
              return x(d.date);
            },
            y: function (d) {
              return y(getDuration(parseDuration(d.duration)));
            },
          });
      }
    </script>
  </body>
</html>
